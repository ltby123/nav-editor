<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>å¯¼èˆªç®¡ç†ç³»ç»Ÿç»ˆæç‰ˆ + æ‰¹é‡ä¿®æ”¹</title>
<style>
body { font-family: "Microsoft YaHei", sans-serif; padding: 20px; background: #f0f2f5; }
h2 { color: #333; margin-bottom: 10px; }
#searchArea { margin-bottom: 10px; }
#searchInput { padding:5px; width:250px; }
button.actionBtn { padding:5px 10px; margin-left:5px; cursor:pointer; border:none; border-radius:5px; color:#fff; }
button.clearBtn{ background:#6c757d; }
button.resetBtn{ background:#28a745; }
button.batchIconBtn{ background:#ffc107; }
button.batchColorBtn{ background:#17a2b8; }
#preview { margin-bottom: 20px; padding: 10px; border-bottom: 2px solid #ccc; background: #fff; border-radius: 8px; }
#preview a { margin-right: 10px; text-decoration: none; font-weight: 500; cursor: pointer; padding: 3px 5px; border-radius: 5px; }
#preview a.active { border: 2px solid #007bff; font-weight: bold; }
#nav { user-select: none; }
.nav-item { display: flex; align-items: center; margin-bottom: 3px; padding: 5px; background: #fff; border-radius: 5px; }
.nav-item.dragging { opacity: 0.5; }
.nav-item input { margin-right: 5px; padding: 5px; width: 100px; }
.nav-item input.active { border: 2px solid #007bff; }
.nav-item input.color-input { width: 60px; }
.nav-item button { padding: 5px 8px; border: none; color: #fff; border-radius: 5px; cursor: pointer; }
.nav-item button.delete { background: #dc3545; }
button#addBtn { background:#007bff; }
button#exportBtn { background:#17a2b8; }
#addArea { margin-top: 10px; }
#importFile { margin-left: 5px; }
#emojiPanel { display:none; position:absolute; background:#fff; border:1px solid #ccc; padding:5px; border-radius:5px; max-width:300px; flex-wrap:wrap; z-index:1000;}
#emojiPanel span { cursor:pointer; font-size:18px; margin:2px; }
#colorPicker { display:none; position:absolute; z-index:1000; }
</style>
</head>
<body>
<h2>å¯¼èˆªç®¡ç†ç³»ç»Ÿç»ˆæç‰ˆ + æ‰¹é‡ä¿®æ”¹</h2>

<div id="searchArea">
  <input id="searchInput" placeholder="æœç´¢å¯¼èˆªï¼ˆåç§°/è·¯å¾„/å›¾æ ‡ï¼‰">
  <button class="actionBtn clearBtn" id="clearSearch">æ¸…ç©ºæœç´¢</button>
  <button class="actionBtn resetBtn" id="resetOrder">é‡ç½®é¡ºåº</button>
  <button class="actionBtn batchIconBtn" id="batchIconBtn">æ‰¹é‡ä¿®æ”¹å›¾æ ‡</button>
  <button class="actionBtn batchColorBtn" id="batchColorBtn">æ‰¹é‡ä¿®æ”¹é¢œè‰²</button>
</div>

<div id="preview"></div>

<div id="editor">
  <div id="nav"></div>
  <hr>
  <div id="addArea">
    <input id="newName" placeholder="å¯¼èˆªåç§°">
    <input id="newPath" placeholder="è·¯å¾„">
    <input id="newIcon" placeholder="å›¾æ ‡/Emoji" readonly>
    <input id="newColor" type="color">
    <button id="addBtn">æ·»åŠ å¯¼èˆª</button>
    <button id="exportBtn">å¯¼å‡ºå¯¼èˆª</button>
    <input type="file" id="importFile" accept=".json">
  </div>
</div>

<div id="emojiPanel"></div>
<input type="color" id="colorPicker">

<script>
let defaultWorkers = [
  { name:"é¦–é¡µ", path:"/", icon:"ğŸ ", color:"#007bff" },
  { name:"å…³äºæˆ‘ä»¬", path:"/about", icon:"â„¹ï¸", color:"#17a2b8" }
];
let workers = JSON.parse(localStorage.getItem("workers")) || [...defaultWorkers];

const nav = document.getElementById("nav");
const preview = document.getElementById("preview");
const addBtn = document.getElementById("addBtn");
const newName = document.getElementById("newName");
const newPath = document.getElementById("newPath");
const newIcon = document.getElementById("newIcon");
const newColor = document.getElementById("newColor");
const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");
const emojiPanel = document.getElementById("emojiPanel");
const colorPicker = document.getElementById("colorPicker");
const searchInput = document.getElementById("searchInput");
const clearSearchBtn = document.getElementById("clearSearch");
const resetOrderBtn = document.getElementById("resetOrder");
const batchIconBtn = document.getElementById("batchIconBtn");
const batchColorBtn = document.getElementById("batchColorBtn");

let activeIndex=-1;
let dragSrcIndex=null;
let currentIconInput=null;
let selectedIndexes = new Set();

const emojis = ["ğŸ ","â„¹ï¸","ğŸ“„","ğŸ“","ğŸ’¡","ğŸ›’","â­","âš™ï¸","ğŸ“§","ğŸ”—"];
emojis.forEach(e=>{
  const span = document.createElement("span");
  span.textContent=e;
  span.onclick=()=>{
    if(currentIconInput){ 
      if(batchMode){ 
        selectedIndexes.forEach(i=>{ workers[i].icon=e; });
      } else {
        currentIconInput.value=e;
      }
      batchMode=false;
      selectedIndexes.clear();
      renderNav(); 
      emojiPanel.style.display="none"; 
    }
  };
  emojiPanel.appendChild(span);
});
let batchMode=false;

function save(){ localStorage.setItem("workers",JSON.stringify(workers)); }

function renderNav(){
  nav.innerHTML=""; preview.innerHTML="";
  const keyword = searchInput.value.trim().toLowerCase();
  const filtered = workers.filter(item=>{
    return item.name.toLowerCase().includes(keyword) ||
           item.path.toLowerCase().includes(keyword) ||
           (item.icon && item.icon.toLowerCase().includes(keyword));
  });

  filtered.forEach((item,index)=>{
    const realIndex = workers.indexOf(item);
    const div=document.createElement("div");
    div.className="nav-item";
    div.draggable=true;

    const selectCheckbox = document.createElement("input");
    selectCheckbox.type="checkbox";
    selectCheckbox.checked = selectedIndexes.has(realIndex);
    selectCheckbox.onchange = e=>{
      if(e.target.checked) selectedIndexes.add(realIndex);
      else selectedIndexes.delete(realIndex);
    };

    const nameInput=document.createElement("input");
    nameInput.value=item.name;
    nameInput.className=(activeIndex===realIndex)?"active":"";
    nameInput.oninput=e=>{ workers[realIndex].name=e.target.value; save(); renderNav(); };

    const pathInput=document.createElement("input");
    pathInput.value=item.path;
    pathInput.className=(activeIndex===realIndex)?"active":"";
    pathInput.oninput=e=>{ workers[realIndex].path=e.target.value; save(); renderNav(); };

    const iconInput=document.createElement("input");
    iconInput.value=item.icon||"";
    iconInput.readOnly=true;
    iconInput.className=(activeIndex===realIndex)?"active":"";
    iconInput.onclick=e=>{
      currentIconInput=iconInput;
      emojiPanel.style.top=(iconInput.getBoundingClientRect().bottom+window.scrollY)+"px";
      emojiPanel.style.left=(iconInput.getBoundingClientRect().left+window.scrollX)+"px";
      emojiPanel.style.display="flex";
    };

    const colorInput=document.createElement("input");
    colorInput.type="color";
    colorInput.value=item.color||"#007bff";
    colorInput.className="color-input";
    colorInput.oninput=e=>{ workers[realIndex].color=e.target.value; save(); renderNav(); };

    const delBtn=document.createElement("button");
    delBtn.textContent="Ã—";
    delBtn.className="delete";
    delBtn.onclick=()=>{ workers.splice(realIndex,1); selectedIndexes.delete(realIndex); if(activeIndex===realIndex) activeIndex=-1; save(); renderNav(); };

    div.append(selectCheckbox,nameInput,pathInput,iconInput,colorInput,delBtn);
    nav.appendChild(div);

    // æ‹–æ‹½
    div.addEventListener("dragstart",()=>{ dragSrcIndex=realIndex; div.classList.add("dragging"); });
    div.addEventListener("dragend",()=>{ div.classList.remove("dragging"); });
    div.addEventListener("dragover",e=>e.preventDefault());
    div.addEventListener("drop",()=>{
      if(dragSrcIndex!==null && dragSrcIndex!==realIndex){
        const dragged=workers[dragSrcIndex];
        workers.splice(dragSrcIndex,1);
        workers.splice(realIndex,0,dragged);
        dragSrcIndex=null;
        save(); renderNav();
      }
    });

    // é¢„è§ˆ
    const link=document.createElement("a");
    link.textContent=(item.icon?item.icon+" ":"")+item.name;
    link.href="#";
    link.style.color=item.color||"#007bff";
    link.className=(activeIndex===realIndex)?"active":"";
    link.onclick=e=>{
      e.preventDefault(); activeIndex=realIndex; renderNav();
      const inputs=nav.getElementsByTagName("input");
      if(inputs.length>=realIndex*5+3){
        inputs[realIndex*5].focus();
      }
    };
    preview.appendChild(link);
  });
  save();
}

// æ·»åŠ 
addBtn.onclick=()=>{
  if(newName.value && newPath.value){
    workers.push({name:newName.value,path:newPath.value,icon:newIcon.value||"",color:newColor.value||"#007bff"});
    newName.value=""; newPath.value=""; newIcon.value=""; newColor.value="#007bff";
    renderNav();
  }else alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");
};

// å¯¼å‡º
exportBtn.onclick=()=>{
  const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(workers,null,2));
  const dlAnchor=document.createElement('a');
  dlAnchor.setAttribute("href",dataStr);
  dlAnchor.setAttribute("download","nav.json");
  dlAnchor.click();
};

// å¯¼å…¥
importFile.onchange=e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=event=>{
    try{
      const json=JSON.parse(event.target.result);
      if(Array.isArray(json)){ workers=json; save(); renderNav(); alert("å¯¼å…¥æˆåŠŸï¼"); }
      else alert("JSON æ ¼å¼ä¸æ­£ç¡®");
    }catch(err){ alert("è§£æ JSON å¤±è´¥"); }
  };
  reader.readAsText(file);
};

// æœç´¢è¾“å…¥äº‹ä»¶
searchInput.addEventListener("input",()=>{ renderNav(); });

// æ¸…ç©ºæœç´¢
clearSearchBtn.onclick=()=>{ searchInput.value=""; renderNav(); };

// é‡ç½®é¡ºåº
resetOrderBtn.onclick=()=>{ workers=[...defaultWorkers]; save(); renderNav(); };

// æ‰¹é‡ä¿®æ”¹å›¾æ ‡
batchIconBtn.onclick=()=>{
  if(selectedIndexes.size===0){ alert("è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„å¯¼èˆª"); return; }
  batchMode=true;
  emojiPanel.style.display="flex";
};

// æ‰¹é‡ä¿®æ”¹é¢œè‰²
batchColorBtn.onclick=()=>{
  if(selectedIndexes.size===0){ alert("è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„å¯¼èˆª"); return; }
  colorPicker.style.top=(batchColorBtn.getBoundingClientRect().bottom+window.scrollY)+"px";
  colorPicker.style.left=(batchColorBtn.getBoundingClientRect().left+window.scrollX)+"px";
  colorPicker.click();
};

// é¢œè‰²é€‰æ‹©äº‹ä»¶
colorPicker.oninput=e=>{
  selectedIndexes.forEach(i=>{ workers[i].color=e.target.value; });
  selectedIndexes.clear();
  renderNav();
};

// ç‚¹å‡»ç©ºç™½éšè— emoji é¢æ¿
document.addEventListener("click", e=>{
  if(!emojiPanel.contains(e.target) && e.target!==currentIconInput){ emojiPanel.style.display="none"; batchMode=false; }
});

renderNav();
</script>
</body>
</html>
